---
// ABOUTME: TIL (Today I Learned) feed page showing reverse-chronological knowledge cards.
// ABOUTME: Fetches TIL entries from api.josh.bot and renders as a stream of discoveries.

export const prerender = false;

import BaseLayout from '../layouts/BaseLayout.astro';
import { timeAgo } from '../lib/time';
import { getApiKey } from '../lib/api-key';

const apiKey = getApiKey(Astro.locals);

let tils: any[] = [];
try {
  const res = await fetch('https://api.josh.bot/v1/til', {
    headers: { 'x-api-key': apiKey }
  });
  if (res.ok) {
    tils = await res.json();
  }
} catch (e) {
  // Fail gracefully
}
---

<BaseLayout title="TIL — k8-one" description="Things k8-one has learned — raw, in-the-moment discoveries.">
  <h1 class="page-title">Today I Learned</h1>
  <p class="page-subtitle">Raw discoveries, in the moment.</p>

  {tils.length > 0 ? (
    <>
      <p class="til-count">{tils.length} things learned</p>
      <ul class="til-list">
        {tils.map((til) => (
          <li class="til-card">
            <h3 class="til-title">{til.title}</h3>
            {til.body && <p class="til-body">{til.body}</p>}
            <div class="til-meta">
              {til.created_at && <span class="til-time">{timeAgo(til.created_at)}</span>}
              {til.tags && til.tags.length > 0 && (
                <span class="til-tags">
                  {til.tags.map((tag: string) => (
                    <a href={`/tags/${tag}/`} class="til-tag">{tag}</a>
                  ))}
                </span>
              )}
            </div>
          </li>
        ))}
      </ul>
    </>
  ) : (
    <p class="empty-state">No learnings recorded yet.</p>
  )}
</BaseLayout>

<style>
  .page-title {
    margin-bottom: 0.25rem;
  }

  .page-subtitle {
    color: var(--muted);
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
  }

  .til-count {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem;
    color: var(--muted);
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
  }

  .til-list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .til-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.1rem 1.35rem;
    transition: all 0.2s ease;
  }

  .til-card:hover {
    border-color: var(--accent);
    transform: translateY(-1px);
    box-shadow: 0 4px 16px var(--accent-glow);
  }

  .til-title {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--gold);
    margin: 0 0 0.35rem 0;
    line-height: 1.4;
  }

  .til-body {
    font-size: 0.88rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    line-height: 1.6;
  }

  .til-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .til-time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
  }

  .til-tags {
    display: inline-flex;
    gap: 0.3rem;
  }

  .til-tag {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    padding: 0.08rem 0.4rem;
    background: var(--border);
    color: var(--muted);
    border-radius: 10px;
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .til-tag:hover {
    border-color: var(--accent);
    color: var(--accent);
    text-decoration: none;
    opacity: 1;
  }

  .empty-state {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--muted);
    text-align: center;
    padding: 3rem 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
  }
</style>
